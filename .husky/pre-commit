#!/usr/bin/env sh
set -e  # Exit immediately if any command fails

# Save original directory
ORIGINAL_DIR=$(pwd)

echo "🎨 Running Biome formatter and linter on staged files..."
# Get staged JS/TS files and run Biome on them
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(js|jsx|ts|tsx)$' | grep -v 'node_modules' | grep -v 'dist/' | grep -v '.next/' | grep -v 'build/' || true)

if [ -n "$STAGED_FILES" ]; then
  echo "  Checking $(echo "$STAGED_FILES" | wc -l | xargs) file(s)..."
  echo "$STAGED_FILES" | xargs npx biome check --write --no-errors-on-unmatched
  # Re-add files that were formatted
  echo "$STAGED_FILES" | xargs git add
else
  echo "  No JS/TS files to check"
fi

echo "🔍 Type-checking TypeScript projects..."

# Only type-check if TS files were changed
if echo "$STAGED_FILES" | grep -q '\.ts' 2>/dev/null; then
  echo "  → API..."
  (cd "$ORIGINAL_DIR/api" && npx tsc --noEmit)

  echo "  → Web..."
  (cd "$ORIGINAL_DIR/web" && npx tsc -b)

  echo "  → IRIS..."
  (cd "$ORIGINAL_DIR/iris" && npm run type-check)

  echo "  → Chat App..."
  (cd "$ORIGINAL_DIR/chat-app" && npm run type-check)
else
  echo "  Skipping (no TypeScript files changed)"
fi

echo "✅ All checks passed!"
exit 0
